/**
 * This file was auto-generated by the Titanium Module SDK helper for Android
 * Appcelerator Titanium Mobile
 * Copyright (c) 2009-2013 by Appcelerator, Inc. All Rights Reserved.
 * Licensed under the terms of the Apache Public License
 * Please see the LICENSE included with this distribution for details.
 *
 */
package eu.rebelcorp.parse;

import org.json.JSONException;
import org.json.JSONObject;

import android.os.Bundle;

import org.appcelerator.kroll.KrollDict;
import org.appcelerator.titanium.TiApplication;

import android.app.ActivityManager;
import android.app.ActivityManager.RecentTaskInfo;
import android.app.ActivityManager.RunningTaskInfo;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.util.Log;

import eu.rebelcorp.parse.ParseModule;
import com.parse.ParsePushBroadcastReceiver;


public class ParseModuleBroadcastReceiver extends ParsePushBroadcastReceiver {

    @Override
    public void onPushOpen(Context context, Intent intent) {
        Intent i = context.getPackageManager().getLaunchIntentForPackage(context.getApplicationContext().getPackageName());

        /* Check if the app is running or in background. If not, just start the app and add the
         * notification as Extra */
        if (ParseModule.getInstance() == null || ParseModule.getInstance().getState() == ParseModule.STATE_DESTROYED) {
            Log.d("onPushOpen", "App was killed; resume the app without triggering 'notificationopen'");
            i.putExtras(intent.getExtras());
            context.startActivity(i);
            return;
        }


        /* Otherwise, just resume the app if necessary, and trigger the event */
        try {
            KrollDict data = new KrollDict(new JSONObject(intent.getExtras().getString("com.parse.Data")));

            if (ParseModule.getInstance().getState() != ParseModule.STATE_RUNNING) {
                Log.d("onPushOpen", "App was in background; resume the app and trigger 'notificationopen'");
                context.startActivity(i);
            } else {
                Log.d("onPushOpen", "App is running in foreground; trigger 'notificationopen'");
            }

            ParseModule.getInstance().fireEvent("notificationopen", data);
        } catch (Exception e) {
            Log.d("onPushOpen", e.getMessage());
        }
    }

    @Override
    public void onPushReceive(Context context, Intent intent) {
        try {
            if (intent == null) {
                Log.d("onPushReceive", "Receiver intent null");
                super.onPushReceive(context, intent);
                return;
            }

            if (ParseModule.getInstance() == null) {
                Log.d("onPushReceive", "No instance of ParseModule found");
                super.onPushReceive(context, intent);
                return;
            }

            /* The notification is received by the device */
            if (ParseModule.getInstance().getState() != ParseModule.STATE_DESTROYED) {
                Log.d("onPushReceive", "App is in foreground; trigger event 'notificationreceive'");

                try {
                    KrollDict data = new KrollDict(new JSONObject(intent.getExtras().getString("com.parse.Data")));
                    ParseModule.getInstance().fireEvent("notificationreceive", data);
                } catch (Exception e) {
                    Log.d("onPushReceive", e.getMessage());
                }
            } else {
                Log.d("onPushReceive", "App is not alive; 'notificationreceive' won't be triggered");
            }

            super.onPushReceive(context, intent);
        } catch (Exception e) {
            Log.e("Push", "Exception: " + e.toString());
        }
    }
}
